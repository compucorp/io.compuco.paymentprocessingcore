name: PHPStan

on: pull_request

env:
  GITHUB_BASE_REF: ${{ github.base_ref }}

jobs:
  run-phpstan:

    runs-on: ubuntu-latest
    container:
      image: compucorp/php-fpm.civicrm:8.1
      options: --user root

    env:
      CIVICRM_EXTENSIONS_DIR: site/web/sites/all/modules/civicrm/tools/extensions

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
        ports:
        - 3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Config mysql database as per CiviCRM requirement
        run: echo "SET GLOBAL sql_mode=(SELECT REPLACE(@@sql_mode,'ONLY_FULL_GROUP_BY',''));" | mysql -u root --password=root --host=mysql

      - name: Config amp
        run: amp config:set --mysql_dsn=mysql://root:root@mysql:3306

      - name: Downgrade buildkit Composer for CiviCRM compatibility
        run: |
          curl -sS https://getcomposer.org/download/2.2.24/composer.phar -o /opt/buildkit/bin/composer
          chmod +x /opt/buildkit/bin/composer

      - name: Build Drupal site
        run: /opt/buildkit/bin/civibuild create drupal-clean --civi-ver 6.4.1 --cms-ver 7.100 --web-root $GITHUB_WORKSPACE/site

      - uses: actions/checkout@v2
        with:
          path: ${{ env.CIVICRM_EXTENSIONS_DIR }}/io.compuco.paymentprocessingcore
          fetch-depth: 0

      - name: Enable Payment Processing Core extension
        working-directory: ${{ env.CIVICRM_EXTENSIONS_DIR }}
        run: cv en paymentprocessingcore

      - name: Install extension dependencies
        working-directory: ${{ env.CIVICRM_EXTENSIONS_DIR }}/io.compuco.paymentprocessingcore
        run: composer install

      - name: Fetch target branch
        working-directory: ${{ env.CIVICRM_EXTENSIONS_DIR }}/io.compuco.paymentprocessingcore
        run: git fetch -n origin ${GITHUB_BASE_REF}

      - name: Download PHPStan
        run: |
          curl -sL https://github.com/phpstan/phpstan/releases/download/1.12.10/phpstan.phar -o /tmp/phpstan.phar
          chmod +x /tmp/phpstan.phar

      - name: Run PHPStan
        working-directory: ${{ env.CIVICRM_EXTENSIONS_DIR }}/io.compuco.paymentprocessingcore
        run: |
          # Create phpstan-ci.neon with CI-specific paths
          cat > phpstan-ci.neon <<EOF
          includes:
            - phpstan-baseline.neon
            - vendor/phpstan/phpstan-phpunit/extension.neon

          parameters:
            level: 9
            reportUnmatchedIgnoredErrors: false
            paths:
              - Civi
              - CRM
              - tests
            excludePaths:
              analyse:
                - CRM/Paymentprocessingcore/DAO/*
                - paymentprocessingcore.civix.php
                - '*.mgd.php'
                - tests/bootstrap.php
            scanFiles:
              - paymentprocessingcore.civix.php
              - stubs/CiviApi4.stub.php
              - $GITHUB_WORKSPACE/site/web/sites/all/modules/civicrm/Civi.php
              - tests/phpunit/BaseHeadlessTest.php
            scanDirectories:
              - CRM/Paymentprocessingcore/DAO
              - $GITHUB_WORKSPACE/site/web/sites/all/modules/civicrm/Civi
              - $GITHUB_WORKSPACE/site/web/sites/all/modules/civicrm/CRM
              - $GITHUB_WORKSPACE/site/web/sites/all/modules/civicrm/api
              - $GITHUB_WORKSPACE/site/web/sites/all/modules/civicrm/packages
              - $GITHUB_WORKSPACE/site/web/sites/all/modules/civicrm/vendor
              - tests
          EOF
          php /tmp/phpstan.phar analyse -c phpstan-ci.neon --memory-limit=1G --error-format=github
